apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-rules
  namespace: monitoring
data:
  cluster-alerts.yaml: |
    groups:
      - name: kubernetes-cluster
        rules:
          # Node alerts
          - alert: NodeNotReady
            expr: kube_node_status_condition{condition="Ready",status="true"} == 0
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: "Node {{ $labels.node }} is not ready"
              description: "Node {{ $labels.node }} has been not ready for more than 5 minutes."
              runbook_url: "https://runbooks.example.com/NodeNotReady"

          - alert: NodeHighCPU
            expr: (100 - (avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)) > 85
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: "High CPU usage on node {{ $labels.instance }}"
              description: "Node {{ $labels.instance }} CPU usage is above 85% (current: {{ $value }}%)"

          - alert: NodeHighMemory
            expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: "High memory usage on node {{ $labels.instance }}"
              description: "Node {{ $labels.instance }} memory usage is above 85% (current: {{ $value }}%)"

          - alert: NodeDiskPressure
            expr: kube_node_status_condition{condition="DiskPressure",status="true"} == 1
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "Node {{ $labels.node }} has disk pressure"
              description: "Node {{ $labels.node }} is under disk pressure."

          - alert: NodeDiskFull
            expr: (1 - (node_filesystem_avail_bytes{fstype!~"tmpfs|overlay"} / node_filesystem_size_bytes{fstype!~"tmpfs|overlay"})) * 100 > 90
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: "Disk almost full on node {{ $labels.instance }}"
              description: "Disk {{ $labels.device }} on {{ $labels.instance }} is {{ $value }}% full"

      - name: kubernetes-pods
        rules:
          - alert: PodCrashLooping
            expr: rate(kube_pod_container_status_restarts_total[15m]) * 60 * 15 > 3
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "Pod {{ $labels.namespace }}/{{ $labels.pod }} is crash looping"
              description: "Pod {{ $labels.namespace }}/{{ $labels.pod }} ({{ $labels.container }}) has restarted {{ $value }} times in the last 15 minutes."

          - alert: PodNotReady
            expr: kube_pod_status_ready{condition="true"} == 0
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: "Pod {{ $labels.namespace }}/{{ $labels.pod }} is not ready"
              description: "Pod {{ $labels.namespace }}/{{ $labels.pod }} has been not ready for more than 10 minutes."

          - alert: ContainerOOMKilled
            expr: kube_pod_container_status_last_terminated_reason{reason="OOMKilled"} == 1
            for: 0m
            labels:
              severity: warning
            annotations:
              summary: "Container {{ $labels.container }} OOM killed"
              description: "Container {{ $labels.container }} in pod {{ $labels.namespace }}/{{ $labels.pod }} was OOM killed."

          - alert: PodHighCPU
            expr: (sum by (namespace, pod) (rate(container_cpu_usage_seconds_total[5m])) / sum by (namespace, pod) (kube_pod_container_resource_limits{resource="cpu"})) * 100 > 90
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: "High CPU usage in pod {{ $labels.namespace }}/{{ $labels.pod }}"
              description: "Pod {{ $labels.namespace }}/{{ $labels.pod }} CPU usage is {{ $value }}% of limits."

          - alert: PodHighMemory
            expr: (sum by (namespace, pod) (container_memory_working_set_bytes) / sum by (namespace, pod) (kube_pod_container_resource_limits{resource="memory"})) * 100 > 90
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: "High memory usage in pod {{ $labels.namespace }}/{{ $labels.pod }}"
              description: "Pod {{ $labels.namespace }}/{{ $labels.pod }} memory usage is {{ $value }}% of limits."

      - name: kubernetes-deployments
        rules:
          - alert: DeploymentReplicasMismatch
            expr: kube_deployment_spec_replicas != kube_deployment_status_replicas_available
            for: 15m
            labels:
              severity: warning
            annotations:
              summary: "Deployment {{ $labels.namespace }}/{{ $labels.deployment }} replicas mismatch"
              description: "Deployment {{ $labels.namespace }}/{{ $labels.deployment }} has {{ $value }} available replicas, expected {{ printf \"kube_deployment_spec_replicas{namespace='%s', deployment='%s'}\" $labels.namespace $labels.deployment | query | first | value }}"

          - alert: DeploymentGenerationMismatch
            expr: kube_deployment_status_observed_generation != kube_deployment_metadata_generation
            for: 15m
            labels:
              severity: critical
            annotations:
              summary: "Deployment {{ $labels.namespace }}/{{ $labels.deployment }} generation mismatch"
              description: "Deployment {{ $labels.namespace }}/{{ $labels.deployment }} has failed to update."

      - name: kubernetes-hpa
        rules:
          - alert: HPAMaxedOut
            expr: kube_horizontalpodautoscaler_status_current_replicas == kube_horizontalpodautoscaler_spec_max_replicas
            for: 30m
            labels:
              severity: warning
            annotations:
              summary: "HPA {{ $labels.namespace }}/{{ $labels.horizontalpodautoscaler }} at max replicas"
              description: "HPA {{ $labels.namespace }}/{{ $labels.horizontalpodautoscaler }} has been at max replicas for 30 minutes."

      - name: application-slo
        rules:
          - alert: HighErrorRate
            expr: sum by (namespace, service) (rate(http_requests_total{status=~"5.."}[5m])) / sum by (namespace, service) (rate(http_requests_total[5m])) * 100 > 5
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: "High error rate for {{ $labels.service }}"
              description: "Service {{ $labels.namespace }}/{{ $labels.service }} has {{ $value }}% error rate."

          - alert: HighLatency
            expr: histogram_quantile(0.95, sum by (namespace, service, le) (rate(http_request_duration_seconds_bucket[5m]))) > 1
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High latency for {{ $labels.service }}"
              description: "Service {{ $labels.namespace }}/{{ $labels.service }} p95 latency is {{ $value }}s."

          - alert: LowAvailability
            expr: (1 - (sum by (namespace, service) (rate(http_requests_total{status=~"5.."}[5m])) / sum by (namespace, service) (rate(http_requests_total[5m])))) * 100 < 99.9
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: "Low availability for {{ $labels.service }}"
              description: "Service {{ $labels.namespace }}/{{ $labels.service }} availability is {{ $value }}%."

      - name: multi-cloud
        rules:
          - alert: CloudProviderDown
            expr: count by (cloud_provider) (kube_node_info) == 0
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: "Cloud provider {{ $labels.cloud_provider }} has no nodes"
              description: "No nodes detected for cloud provider {{ $labels.cloud_provider }}."

          - alert: CrossCloudLatencyHigh
            expr: avg by (cloud_provider) (histogram_quantile(0.95, sum by (cloud_provider, le) (rate(http_request_duration_seconds_bucket[5m])))) > 0.5
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: "High cross-cloud latency for {{ $labels.cloud_provider }}"
              description: "Latency to {{ $labels.cloud_provider }} is {{ $value }}s."

          - alert: CloudCostAnomaly
            expr: increase(cloud_cost_total[1h]) > (avg_over_time(cloud_cost_total[7d]) * 1.5)
            for: 1h
            labels:
              severity: warning
            annotations:
              summary: "Cost anomaly detected for {{ $labels.cloud_provider }}"
              description: "Cloud costs for {{ $labels.cloud_provider }} have increased significantly."
